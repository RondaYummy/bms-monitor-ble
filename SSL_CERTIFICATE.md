# üõ°Ô∏è –û—Ç—Ä–∏–º–∞–Ω–Ω—è SSL-—Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞: –ú–µ—Ç–æ–¥ DNS-01 (Certbot Manual)
–û—Å–∫—ñ–ª—å–∫–∏ –ø–æ—Ä—Ç–∏ 80/443 –º–æ–∂—É—Ç—å –±—É—Ç–∏ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω—ñ, –º–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –º–µ—Ç–æ–¥ DNS-01 (—á–µ—Ä–µ–∑ --manual —Ç–∞ --preferred-challenges dns), —è–∫–∏–π –¥–æ–≤–æ–¥–∏—Ç—å –≤–æ–ª–æ–¥—ñ–Ω–Ω—è –¥–æ–º–µ–Ω–æ–º —à–ª—è—Ö–æ–º –¥–æ–¥–∞–≤–∞–Ω–Ω—è —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ–≥–æ TXT-–∑–∞–ø–∏—Å—É –¥–æ –≤–∞—à–æ–≥–æ DNS.

**–¶–µ–π –ø—Ä–æ—Ü–µ—Å —î –Ω–∞–ø—ñ–≤–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–º —ñ –≤–∏–º–∞–≥–∞—î —Ä—É—á–Ω–æ–≥–æ –≤—Ç—Ä—É—á–∞–Ω–Ω—è.**

### –ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è
- –°–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏ Let's Encrypt –¥—ñ–π—Å–Ω—ñ **90 –¥–Ω—ñ–≤** ‚Äî –Ω–µ–æ–±—Ö—ñ–¥–Ω–µ —Ä–µ–≥—É–ª—è—Ä–Ω–µ –ø–æ–Ω–æ–≤–ª–µ–Ω–Ω—è.
- –ú–µ—Ç–æ–¥ `--manual` –Ω–µ –ø—ñ–¥—Ö–æ–¥–∏—Ç—å –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –±–µ–∑ —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—ó DNS-API; –¥–æ–≤–µ–¥–µ—Ç—å—Å—è –≤—Ä—É—á–Ω—É –ø–æ–≤—Ç–æ—Ä—é–≤–∞—Ç–∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—É –ø—Ä–∏ –∫–æ–∂–Ω–æ–º—É –ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—ñ.
- ertbot –º–æ–∂–µ –ª–æ–≥—É–≤–∞—Ç–∏ –≤–∞—à IP —É –ø—É–±–ª—ñ—á–Ω—ñ –ª–æ–≥–∏ –ø—Ä–∏ `--manual` (–¥–æ–¥–∞—Ç–∫–æ–≤–æ: –¥–æ–¥–∞–≤–∞–π—Ç–µ `--manual-public-ip-logging-ok`, —è–∫—â–æ –ø–æ–≥–æ–¥–∂—É—î—Ç–µ—Å—å).

## 1. –ö–æ–º–∞–Ω–¥–∏ –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è / –ø–æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞
 1.1 –ë–∞–∑–æ–≤–∞ (—ñ–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞) –∫–æ–º–∞–Ω–¥–∞

 ```bash
 sudo certbot certonly --manual --preferred-challenges dns -d solar.levych.com
```

 1.2 –ö–æ–º–∞–Ω–¥–∞ –∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–º –∑–∞–ø–∏—Å–æ–º –¥–∞—Ç–∏ –ø–æ–Ω–æ–≤–ª–µ–Ω–Ω—è –≤ SQLite (–≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ Certbot —É—Å–ø—ñ—à–Ω–∏–π)
(–ü–µ—Ä—à–∞ –≤–µ—Ä—Å—ñ—è –∑–∞–ø–∏—Å—É—î –ø–æ—Ç–æ—á–Ω–∏–π —á–∞—Å –∑ –æ–±–æ–ª–æ–Ω–∫–∏; –¥—Ä—É–≥–∞ ‚Äî –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î sqlite datetime('now','utc').)

```bash
sudo certbot certonly --manual --preferred-challenges dns -d solar.levych.com \
  && CURRENT_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ) \
  && docker exec bms-monitor-ble-python-app-1 sqlite3 /app/data/bms_data.db "INSERT INTO ssl_certificates (created_at, days) VALUES ('$CURRENT_DATE', 90);"

```

–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ (–±–µ–∑–ø–µ—á–Ω—ñ—à–µ, —â–æ–± —á–∞—Å –≤—Å—Ç–∞–Ω–æ–≤–∏–≤ sqlite –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞):

```bash
sudo certbot certonly --manual --preferred-challenges dns -d solar.levych.com \
  && docker exec bms-monitor-ble-python-app-1 sqlite3 /app/data/bms_data.db "INSERT INTO ssl_certificates (created_at, days) VALUES (datetime('now', 'utc'), 90);"
```

**–ü—Ä–∏–º—ñ—Ç–∫–∞:** && –≥–∞—Ä–∞–Ω—Ç—É—î, —â–æ –∑–∞–ø–∏—Å –≤ –ë–î –≤–∏–∫–æ–Ω–∞—î—Ç—å—Å—è –ª–∏—à–µ –ø—Ä–∏ —É—Å–ø—ñ—à–Ω–æ–º—É –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ñ Certbot.

## 2. –ü—Ä–æ—Ü–µ—Å –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ (Challenge)
–ü—ñ—Å–ª—è –∑–∞–ø—É—Å–∫—É Certbot:
- 1. Certbot –∑–≥–µ–Ω–µ—Ä—É—î —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π —Ä—è–¥–æ–∫ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ (Challenge).
- 2. –í—ñ–Ω –≤–∏–≤–µ–¥–µ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—é –¥–æ–¥–∞—Ç–∏ TXT-–∑–∞–ø–∏—Å –¥–æ DNS:

```bash
Please deploy a DNS TXT record under the name
_acme-challenge.solar.levych.com with the following value:

[–£–ù–Ü–ö–ê–õ–¨–ù–ò–ô_–°–¢–†–û–ö_–ü–ï–†–ï–í–Ü–†–ö–ò]

Before continuing, verify the record is deployed.
- Press Enter to Continue
```

## 3. –í–∞—à—ñ –¥—ñ—ó —É –ø–∞–Ω–µ–ª—ñ DNS-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
–í–∞–º –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ –∑–∞–π—Ç–∏ –≤ –ø–∞–Ω–µ–ª—å –∫–µ—Ä—É–≤–∞–Ω–Ω—è –≤–∞—à–æ–≥–æ DNS-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, GoDaddy) —ñ –¥–æ–¥–∞—Ç–∏ –Ω–æ–≤–∏–π –∑–∞–ø–∏—Å:

- **–¢–∏–ø:** TXT	–¢–∏–ø –∑–∞–ø–∏—Å—É
- **–Ü–º'—è / –•–æ—Å—Ç:** `_acme-challenge.solar`	**–í–∞–∂–ª–∏–≤–æ:** Certbot –ø—Ä–æ—Å–∏—Ç—å –ø–æ–≤–Ω–µ —ñ–º'—è `_acme-challenge.solar.levych.com`. –ù–∞ –±—ñ–ª—å—à–æ—Å—Ç—ñ –ø–∞–Ω–µ–ª–µ–π –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤–≤–µ—Å—Ç–∏ –ª–∏—à–µ –ø—Ä–µ—Ñ—ñ–∫—Å `_acme-challenge.solar`.
- **–ó–Ω–∞—á–µ–Ω–Ω—è:** `[–£–ù–Ü–ö–ê–õ–¨–ù–ò–ô_–†–Ø–î–û–ö_–ü–ï–†–ï–í–Ü–†–ö–ò]`	–£–Ω—ñ–∫–∞–ª—å–Ω–∏–π —Ä—è–¥–æ–∫, —è–∫–∏–π Certbot —â–æ–π–Ω–æ –Ω–∞–¥–∞–≤.
- **TTL:** 60 –∞–±–æ 300 (–º—ñ–Ω—ñ–º–∞–ª—å–Ω–µ)	–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –º—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π —á–∞—Å –∂–∏—Ç—Ç—è (Time To Live), —â–æ–± –∑–∞–ø–∏—Å —à–≤–∏–¥–∫–æ –ø–æ—à–∏—Ä–∏–≤—Å—è.

## 4. –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
- –ü–æ—á–µ–∫–∞–π—Ç–µ 30‚Äì300 —Å (–∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ TTL —ñ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞).
- –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ TXT-–∑–∞–ø–∏—Å (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, `dig` –∞–±–æ –æ–Ω–ª–∞–π–Ω-—ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏):
https://toolbox.googleapps.com/apps/dig/#TXT/_acme-challenge.solar.levych.com
- –ü–æ–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –≤ —Ç–µ—Ä–º—ñ–Ω–∞–ª ‚Üí –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å `Enter`. Certbot –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç—å –∑–∞–ø–∏—Å —ñ, —è–∫—â–æ –≤—ñ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π, –∑–±–µ—Ä–µ —Ç–∞ –∑–±–µ—Ä–µ–∂–µ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç.

–†–µ–∑—É–ª—å—Ç–∞—Ç: —Ñ–∞–π–ª–∏ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è —É `/etc/letsencrypt/live/solar.levych.com/`:
- `fullchain.pem` ‚Äî —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç
- `privkey.pem` ‚Äî –ø—Ä–∏–≤–∞—Ç–Ω–∏–π –∫–ª—é—á

**–í–ê–ñ–õ–ò–í–û:** –¶–µ–π TXT-–∑–∞–ø–∏—Å —î —Ç–∏–º—á–∞—Å–æ–≤–∏–º. –í–∏ –º–æ–∂–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –π–æ–≥–æ –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞. –û–¥–Ω–∞–∫, –π–æ–≥–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –±—É–¥–µ —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –∑–Ω–æ–≤—É –ø—Ä–∏ –∫–æ–∂–Ω–æ–º—É –ø–æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ.

5. –ü—ñ—Å–ª—è —É—Å–ø—ñ—Ö—É ‚Äî –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–µ—Ä–≤–µ—Ä–∞
–©–æ–± `nginx` (–∞–±–æ —ñ–Ω—à–∏–π —Å–µ—Ä–≤–µ—Ä) –ø—ñ–¥—Ö–æ–ø–∏–≤ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç:

```bash
sudo systemctl reload nginx
# –∞–±–æ —è–∫—â–æ reload –Ω–µ —Å–ø—Ä–∞—Ü—é—î:
# sudo systemctl restart nginx
```

–Ø–∫—â–æ nginx –ø—Ä–∞—Ü—é—î –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ Docker, —Ç–æ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞/—Å–µ—Ä–≤—ñ—Å—É:

```bash
docker exec <nginx-container> nginx -s reload
# –∞–±–æ docker restart <nginx-container>
```

6. –ü–æ—Ä–∞–¥–∏ —Ç–∞ –ø–æ–ª—ñ–ø—à–µ–Ω–Ω—è
- **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü—ñ—è**: –∑–∞–º—ñ—Å—Ç—å `--manual` –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π DNS-–ø–ª–∞–≥—ñ–Ω–∏ Certbot (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥ `certbot-dns-cloudflare`, `certbot-dns-google` —Ç–æ—â–æ). –í–æ–Ω–∏ –¥–æ–∑–≤–æ–ª—è—é—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ `TXT-–∑–∞–ø–∏—Å–∏` —ñ **–ø–æ–≤–Ω—ñ—Å—Ç—é –∞–≤—Ç–æ–º–∞—Ç–∏–∑—É–≤–∞—Ç–∏** –ø–æ–Ω–æ–≤–ª–µ–Ω–Ω—è. –î—É–∂–µ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ –¥–ª—è `production`.
- **–ë–µ–∑–ø–µ–∫–∞ –∫–ª—é—á—ñ–≤**: –ø–µ—Ä–µ–∫–æ–Ω–∞–π—Å—è, —â–æ `privkey.pem` –∑–∞—Ö–∏—â–µ–Ω–∏–π (–ø—Ä–∞–≤–∏–ª—å–Ω—ñ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø—É).
- **–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞**: `certbot certificates` –ø–æ–∫–∞–∑—É—î –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ñ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏ —Ç–∞ —à–ª—è—Ö–∏.
- **–ü–ª–∞–Ω—É–≤–∞–Ω–Ω—è –ø–æ–Ω–æ–≤–ª–µ–Ω—å**: —è–∫—â–æ –ª–∏—à–∞—î—à manual, —Å—Ç–∞–≤ —Å–æ–±—ñ –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è `~60 –¥–Ω—ñ–≤` –ø—ñ—Å–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è, –±–æ Certbot –Ω–µ –∑–º–æ–∂–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–Ω–æ–≤–∏—Ç–∏. –ö—Ä–∞—â–µ –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ `cron/systemd timer`, —è–∫—â–æ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü—ñ—è –¥–æ—Å—Ç—É–ø–Ω–∞.
- **–õ–æ–≥–∏**: –¥–∏–≤–∏—Å—å `/var/log/letsencrypt/letsencrypt.log` –ø—Ä–∏ –ø–æ–º–∏–ª–∫–∞—Ö.
- **–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä/—à–ª—è—Ö–∏**: –ø–µ—Ä–µ–∫–æ–Ω–∞–π—Å—è, —â–æ —à–ª—è—Ö –¥–æ –ë–î `/app/data/bms_data.db` —ñ –Ω–∞–∑–≤–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ `bms-monitor-ble-python-app-1` –∞–∫—Ç—É–∞–ª—å–Ω—ñ.